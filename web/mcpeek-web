#!/usr/bin/env python3
"""
MCPeek Web Interface Entry Point
Launches the web interface with proper environment setup
"""

import os
import sys
import subprocess
import signal
import time
from pathlib import Path

def setup_environment():
    """Set up environment variables for the web interface"""
    web_dir = Path(__file__).parent
    
    # Set default environment variables if not already set
    env_vars = {
        'MCPEEK_WEB_HOST': '127.0.0.1',
        'MCPEEK_WEB_PORT': '8080',
        'MCPEEK_LOG_LEVEL': 'INFO',
        'MCPEEK_DEBUG': 'false',
        'MCPEEK_CORS_ORIGINS': 'http://localhost:3000,http://127.0.0.1:3000,http://localhost:8080,http://127.0.0.1:8080'
    }
    
    for key, value in env_vars.items():
        if key not in os.environ:
            os.environ[key] = value

def check_dependencies():
    """Check if required dependencies are installed"""
    try:
        import fastapi
        import uvicorn
        import aiohttp
        import rich
        import pydantic
        return True
    except ImportError as e:
        print(f"‚ùå Missing dependency: {e}")
        print("Please install with: pip install -e .[web]")
        return False

def main():
    """Main entry point"""
    print("üöÄ MCPeek Web Interface")
    print("=" * 50)
    
    # Check dependencies
    if not check_dependencies():
        sys.exit(1)
    
    # Setup environment
    setup_environment()
    
    # Get configuration
    host = os.environ.get('MCPEEK_WEB_HOST', '127.0.0.1')
    port = int(os.environ.get('MCPEEK_WEB_PORT', '8080'))
    
    print(f"üåê Starting web interface at http://{host}:{port}")
    print(f"üìö API Documentation: http://{host}:{port}/api/docs")
    print(f"üéÆ Terminal Interface: http://{host}:{port}")
    print("Press Ctrl+C to stop")
    print("")
    
    # Launch the backend server
    try:
        backend_dir = Path(__file__).parent / "backend"
        app_path = backend_dir / "app.py"
        
        if not app_path.exists():
            print(f"‚ùå Backend app not found: {app_path}")
            sys.exit(1)
        
        # Change to backend directory and run the app
        os.chdir(backend_dir)
        
        # Use uvicorn directly for better control
        import uvicorn
        uvicorn.run(
            "app:app",
            host=host,
            port=port,
            reload=os.environ.get('MCPEEK_DEBUG', 'false').lower() == 'true',
            log_level="info"
        )
        
    except KeyboardInterrupt:
        print("\nüõë Shutting down...")
        sys.exit(0)
    except Exception as e:
        print(f"‚ùå Error starting web interface: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()